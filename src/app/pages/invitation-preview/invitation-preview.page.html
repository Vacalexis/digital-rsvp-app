@if (event(); as currentEvent) {
<!-- ==================== HEADER - S√ì NA CONFIGURA√á√ÉO ==================== -->
@if (currentPhase() === 'setup') {
<ion-header class="ion-no-border">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button [defaultHref]="'/events/' + eventId()"></ion-back-button>
    </ion-buttons>
    <ion-title>Configurar Preview</ion-title>
  </ion-toolbar>
</ion-header>
}

<!-- ==================== PHASE 1: SETUP ==================== -->
@if (currentPhase() === 'setup') {
<ion-content class="setup-phase">
  <div class="setup-container">
    <div class="setup-header">
      <ion-icon name="eye-outline" class="header-icon"></ion-icon>
      <h1>Pr√©-visualizar Convite</h1>
      <p>Configure como quer visualizar o convite antes de enviar aos convidados.</p>
    </div>

    <!-- Template Selection -->
    <div class="template-section">
      <h2>Tipo de Convite</h2>
      <div class="template-grid">
        @for (template of templates; track template.id) {
        <div
          class="template-card"
          [class.selected]="selectedTemplate() === template.id"
          (click)="selectTemplate(template.id)"
        >
          <ion-icon [name]="template.icon"></ion-icon>
          <span class="template-label">{{ template.label }}</span>
          <span class="template-desc">{{ template.description }}</span>
        </div>
        }
      </div>
    </div>

    <!-- Names Configuration -->
    <div class="names-section">
      <h2>Personalizar Nomes</h2>
      
      <div class="form-group">
        <label>Nome principal *</label>
        <ion-input
          [(ngModel)]="config.primaryName"
          placeholder="Ex: Maria Silva"
          fill="outline"
        ></ion-input>
      </div>

      @if (showSecondaryGuest()) {
      <div class="form-group">
        <label>Nome do parceiro/a *</label>
        <ion-input
          [(ngModel)]="config.secondaryName"
          placeholder="Ex: Jo√£o Costa"
          fill="outline"
        ></ion-input>
      </div>
      }

      @if (config.type === 'family') {
      <div class="form-group">
        <label>N√∫mero de filhos</label>
        <ion-select
          [(ngModel)]="config.childrenCount"
          interface="popover"
          fill="outline"
        >
          <ion-select-option [value]="1">1 filho</ion-select-option>
          <ion-select-option [value]="2">2 filhos</ion-select-option>
          <ion-select-option [value]="3">3 filhos</ion-select-option>
          <ion-select-option [value]="4">4 filhos</ion-select-option>
          <ion-select-option [value]="5">5 filhos</ion-select-option>
        </ion-select>
      </div>
      }

      @if (config.type === 'single' && currentEvent.allowPlusOne) {
      <ion-item lines="none" class="toggle-item">
        <ion-toggle [(ngModel)]="config.allowPlusOne">
          Simular com op√ß√£o de acompanhante
        </ion-toggle>
      </ion-item>
      }
    </div>

    <!-- Preview Button -->
    <div class="action-section">
      <ion-button expand="block" (click)="startPreview()" class="preview-button">
        <ion-icon slot="start" name="eye-outline"></ion-icon>
        Ver Pr√©-visualiza√ß√£o
      </ion-button>
      
      <p class="hint">
        Poder√° voltar a editar estes dados a qualquer momento.
      </p>
    </div>
  </div>
</ion-content>
}

<!-- ==================== PHASES 2 & 3: ENVELOPE + PREVIEW ==================== -->
@if (currentPhase() === 'envelope' || currentPhase() === 'preview') {
<ion-content class="preview-content">
  <!-- Bot√£o voltar discreto -->
  <ion-button class="preview-back-button" fill="clear" size="small" (click)="backToSetup()">
    <ion-icon slot="icon-only" name="arrow-back-outline"></ion-icon>
  </ion-button>

  <!-- Preview Badge - sempre vis√≠vel -->
  <div class="preview-badge" [class.fade-in]="currentPhase() === 'preview'">
    <ion-icon name="eye-outline"></ion-icon>
    <span>Modo Pr√©-visualiza√ß√£o</span>
  </div>

  <!-- Envelope Overlay + Convite real dentro da carta -->
  <div class="envelope-overlay">
    <app-envelope-opener
      [event]="currentEvent"
      (opened)="onEnvelopeOpened()"
    >
      <app-invitation-card
        [event]="currentEvent"
        [showEnvelope]="false"
        [showCountdown]="true"
        [showSchedule]="true"
      >
      <!-- RSVP Form - Real experience -->
      <div class="rsvp-form">
      <h2>Confirma a tua presen√ßa</h2>

      <!-- Personalized Greeting -->
      <div class="personalized-greeting">
        <p class="greeting">
          Ol√° <strong>{{ getGreetingNames() }}</strong>,
        </p>
        <p class="greeting-sub">{{ getGreetingSubtext() }}</p>
      </div>

      <!-- RSVP Form for Couple/Family -->
      @if (showSecondaryGuest()) {
      <div class="couple-rsvp-section">
        <div class="guest-card">
          <h4>{{ config.primaryName }}</h4>
          <div class="radio-options compact">
            <div
              class="radio-option"
              [class.selected]="attendingPreview === 'yes'"
              (click)="attendingPreview = 'yes'"
            >
              <ion-icon name="checkmark-circle-outline" color="success"></ion-icon>
              <span>Sim</span>
            </div>
            <div
              class="radio-option"
              [class.selected]="attendingPreview === 'no'"
              (click)="attendingPreview = 'no'"
            >
              <ion-icon name="close-circle-outline" color="danger"></ion-icon>
              <span>N√£o</span>
            </div>
          </div>
        </div>

        <div class="guest-card">
          <h4>{{ config.secondaryName }}</h4>
          <div class="radio-options compact">
            <div
              class="radio-option"
              [class.selected]="secondaryAttendingPreview"
              (click)="secondaryAttendingPreview = true"
            >
              <ion-icon name="checkmark-circle-outline" color="success"></ion-icon>
              <span>Sim</span>
            </div>
            <div
              class="radio-option"
              [class.selected]="!secondaryAttendingPreview"
              (click)="secondaryAttendingPreview = false"
            >
              <ion-icon name="close-circle-outline" color="danger"></ion-icon>
              <span>N√£o</span>
            </div>
          </div>
        </div>
      </div>
      } @else {
      <!-- Single Mode -->
      <div class="form-group">
        <label>Vai poder estar presente?</label>
        <div class="radio-options">
          <div
            class="radio-option"
            [class.selected]="attendingPreview === 'yes'"
            (click)="attendingPreview = 'yes'"
          >
            <ion-icon name="checkmark-circle-outline" color="success"></ion-icon>
            <span>Sim, estarei presente!</span>
          </div>
          <div
            class="radio-option"
            [class.selected]="attendingPreview === 'no'"
            (click)="attendingPreview = 'no'"
          >
            <ion-icon name="close-circle-outline" color="danger"></ion-icon>
            <span>Infelizmente n√£o poderei</span>
          </div>
          <div
            class="radio-option"
            [class.selected]="attendingPreview === 'maybe'"
            (click)="attendingPreview = 'maybe'"
          >
            <ion-icon name="help-circle-outline" color="medium"></ion-icon>
            <span>Ainda n√£o sei</span>
          </div>
        </div>
      </div>
      }

      <!-- Dietary for couple mode -->
      @if (showSecondaryGuest() && currentEvent.askDietaryRestrictions) {
        @if (attendingPreview === 'yes') {
        <div class="form-group">
          <label>Restri√ß√µes alimentares de {{ config.primaryName }}</label>
          <app-dietary-select [(ngModel)]="primaryDietary"></app-dietary-select>
        </div>
        }
        @if (secondaryAttendingPreview) {
        <div class="form-group">
          <label>Restri√ß√µes alimentares de {{ config.secondaryName }}</label>
          <app-dietary-select [(ngModel)]="secondaryDietary"></app-dietary-select>
        </div>
        }
      }

      <!-- Plus One (for single type) -->
      @if (attendingPreview === 'yes' && showPlusOneOption()) {
      <div class="form-group">
        <ion-item lines="none" class="toggle-item">
          <ion-toggle [(ngModel)]="bringingPlusOnePreview">
            Vou levar acompanhante
          </ion-toggle>
        </ion-item>
        @if (bringingPlusOnePreview) {
        <ion-input
          [(ngModel)]="plusOneNamePreview"
          placeholder="Nome do acompanhante"
          fill="outline"
          class="plus-one-input"
        ></ion-input>

        @if (currentEvent.askDietaryRestrictions) {
        <div class="plus-one-dietary">
          <label>Restri√ß√µes alimentares do acompanhante</label>
          <app-dietary-select [(ngModel)]="plusOneDietary"></app-dietary-select>
        </div>
        }
        }
      </div>
      }

      <!-- Children Section -->
      @if (showChildrenSection()) {
      <div class="form-group children-section">
        <label>Quantos filhos v√£o estar presentes?</label>
        <ion-select
          [(ngModel)]="childrenAttendingPreview"
          interface="popover"
          fill="outline"
        >
          @for (i of getChildrenOptions(); track i) {
          <ion-select-option [value]="i">{{ i }}</ion-select-option>
          }
        </ion-select>

        @if (childrenAttendingPreview > 0 && currentEvent.askDietaryRestrictions) {
        <div class="children-dietary">
          <label>Restri√ß√µes alimentares das crian√ßas</label>
          <app-dietary-select [(ngModel)]="childrenDietary"></app-dietary-select>
        </div>
        }
      </div>
      }

      <!-- Primary Dietary (single mode) -->
      @if (attendingPreview === 'yes' && currentEvent.askDietaryRestrictions && !showSecondaryGuest()) {
      <div class="form-group">
        <label>Restri√ß√µes alimentares ou alergias</label>
        <app-dietary-select [(ngModel)]="primaryDietary"></app-dietary-select>
      </div>
      }

      @if (attendingPreview === 'yes' && currentEvent.askSongRequest) {
      <div class="form-group">
        <label>Sugest√£o de m√∫sica üéµ</label>
        <ion-input
          [(ngModel)]="songRequestPreview"
          placeholder="Qual m√∫sica n√£o pode faltar?"
          fill="outline"
        ></ion-input>
      </div>
      }

      <div class="form-group">
        <label>Mensagem para os anfitri√µes</label>
        <ion-textarea
          [(ngModel)]="messagePreview"
          placeholder="Deixe uma mensagem..."
          fill="outline"
          [autoGrow]="true"
          rows="3"
        ></ion-textarea>
      </div>

      <ion-button expand="block" class="submit-button" disabled>
        Confirmar Resposta (pr√©-visualiza√ß√£o)
      </ion-button>

      @if (currentEvent.rsvpDeadline) {
      <p class="deadline">
        Responde at√© {{ formatDate(currentEvent.rsvpDeadline) }}
      </p>
      }
      </div>
    </app-invitation-card>
    </app-envelope-opener>
  </div>
</ion-content>
}

} @else {
<!-- Event not found -->
<ion-header class="ion-no-border">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/events"></ion-back-button>
    </ion-buttons>
    <ion-title>Evento n√£o encontrado</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <p>O evento n√£o foi encontrado.</p>
</ion-content>
}
