<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button [defaultHref]="'/preview/' + theme()"></ion-back-button>
    </ion-buttons>
    <ion-title>Personalizar Convite</ion-title>
    <ion-chip slot="end" class="theme-chip">
      <ion-icon name="heart-outline"></ion-icon>
      <ion-label>{{ themeNames[theme()] }}</ion-label>
    </ion-chip>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="customize-content">
  <div class="customize-container">
    <!-- Form Section -->
    <div class="form-section">
      <div class="section-header">
        <h2>Detalhes do Evento</h2>
        <p>Preencha os campos para personalizar o seu convite</p>
      </div>

      <!-- Event Type -->
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="calendar-outline"></ion-icon>
            Tipo de Evento
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-item>
            <ion-select
              [(ngModel)]="eventType"
              (ionChange)="onEventTypeChange()"
              label="Selecione o tipo"
              label-placement="stacked"
              interface="action-sheet"
            >
              @for (type of eventTypes; track type.value) {
                <ion-select-option [value]="type.value">
                  {{ type.label }}
                </ion-select-option>
              }
            </ion-select>
          </ion-item>
        </ion-card-content>
      </ion-card>

      <!-- Hosts -->
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="people-outline"></ion-icon>
            Anfitriões
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-item>
            <ion-input
              [(ngModel)]="hosts[0]"
              (ionInput)="onHostChange()"
              label="Nome do primeiro anfitrião"
              label-placement="stacked"
              placeholder="Ex: Ana Silva"
              [required]="true"
            ></ion-input>
          </ion-item>

          @if (eventType === 'wedding') {
            <ion-item>
              <ion-input
                [(ngModel)]="hosts[1]"
                (ionInput)="onHostChange()"
                label="Nome do segundo anfitrião"
                label-placement="stacked"
                placeholder="Ex: João Santos"
              ></ion-input>
            </ion-item>
          }
        </ion-card-content>
      </ion-card>

      <!-- Event Details -->
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="heart-outline"></ion-icon>
            Detalhes
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-item>
            <ion-input
              [(ngModel)]="title"
              label="Título do convite"
              label-placement="stacked"
              placeholder="Ex: O Nosso Casamento"
              helperText="Deixe vazio para gerar automaticamente"
            ></ion-input>
          </ion-item>

          <ion-item>
            <ion-input
              [(ngModel)]="subtitle"
              label="Subtítulo (opcional)"
              label-placement="stacked"
              placeholder="Ex: Celebrem connosco o nosso dia especial"
            ></ion-input>
          </ion-item>

          <ion-item>
            <ion-textarea
              [(ngModel)]="description"
              label="Mensagem (opcional)"
              label-placement="stacked"
              placeholder="Ex: Junte-se a nós para celebrar o amor..."
              [rows]="3"
              [autoGrow]="true"
            ></ion-textarea>
          </ion-item>
        </ion-card-content>
      </ion-card>

      <!-- Date & Time -->
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="calendar-outline"></ion-icon>
            Data e Hora
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-item>
            <ion-input
              [(ngModel)]="date"
              type="date"
              label="Data do evento"
              label-placement="stacked"
              [required]="true"
            ></ion-input>
          </ion-item>

          <ion-item>
            <ion-input
              [(ngModel)]="time"
              type="time"
              label="Hora (opcional)"
              label-placement="stacked"
            ></ion-input>
          </ion-item>

          <ion-item>
            <ion-input
              [(ngModel)]="endTime"
              type="time"
              label="Hora de fim (opcional)"
              label-placement="stacked"
              helperText="Deixe vazio se não aplicável"
            ></ion-input>
          </ion-item>
        </ion-card-content>
      </ion-card>

      <!-- Event Schedule/Program -->
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="time-outline"></ion-icon>
            Programa do Evento
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <p class="schedule-helper">
            Adicione os momentos principais do seu evento (cerimónia, cocktail, jantar, etc.)
          </p>

          <!-- Schedule Items List -->
          @for (item of form().scheduleItems; track item.id; let i = $index) {
            <div class="schedule-item">
              <div class="schedule-item-header">
                <h3>Momento {{ i + 1 }}</h3>
                <ion-button
                  fill="clear"
                  color="danger"
                  size="small"
                  (click)="removeScheduleItem(i)"
                  [disabled]="form().scheduleItems.length <= 1"
                >
                  <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
                </ion-button>
              </div>

              <ion-item>
                <ion-input
                  [value]="item.time"
                  (ionInput)="updateScheduleItemTime(i, $any($event.target).value)"
                  type="time"
                  label="Hora"
                  label-placement="stacked"
                  placeholder="15:00"
                ></ion-input>
              </ion-item>

              <ion-item>
                <ion-input
                  [value]="item.title"
                  (ionInput)="updateScheduleItemTitle(i, $any($event.target).value)"
                  label="Título"
                  label-placement="stacked"
                  placeholder="Ex: Cerimónia"
                ></ion-input>
              </ion-item>

              <ion-item>
                <ion-textarea
                  [value]="item.description"
                  (ionInput)="updateScheduleItemDescription(i, $any($event.target).value)"
                  label="Descrição (opcional)"
                  label-placement="stacked"
                  placeholder="Ex: Cerimónia religiosa na capela"
                  [rows]="2"
                  [autoGrow]="true"
                ></ion-textarea>
              </ion-item>
            </div>
          } @empty {
            <p class="no-items-text">Nenhum momento adicionado ainda.</p>
          }

          <!-- Add Button -->
          <ion-button
            expand="block"
            fill="outline"
            (click)="addScheduleItem()"
            class="add-schedule-btn"
          >
            <ion-icon slot="start" name="add-outline"></ion-icon>
            Adicionar Momento
          </ion-button>
        </ion-card-content>
      </ion-card>

      <!-- Venue -->
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="location-outline"></ion-icon>
            Local
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-item>
            <ion-input
              [(ngModel)]="venueName"
              label="Nome do local"
              label-placement="stacked"
              placeholder="Ex: Quinta do Vale"
              [required]="true"
            ></ion-input>
          </ion-item>

          <ion-item>
            <ion-input
              [(ngModel)]="venueAddress"
              label="Endereço"
              label-placement="stacked"
              placeholder="Ex: Rua das Flores, 123"
            ></ion-input>
          </ion-item>

          <ion-item>
            <ion-input
              [(ngModel)]="venueCity"
              label="Cidade"
              label-placement="stacked"
              placeholder="Ex: Lisboa"
            ></ion-input>
          </ion-item>

          <ion-item>
            <ion-input
              [(ngModel)]="venueCountry"
              label="País"
              label-placement="stacked"
              placeholder="Portugal"
            ></ion-input>
          </ion-item>
        </ion-card-content>
      </ion-card>

      <!-- Options -->
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="settings-outline"></ion-icon>
            Opções de RSVP
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-item>
            <ion-toggle [(ngModel)]="allowPlusOne" [enableOnOffLabels]="true">
              Permitir acompanhantes (+1)
            </ion-toggle>
          </ion-item>

          <ion-item>
            <ion-toggle [(ngModel)]="askDietaryRestrictions" [enableOnOffLabels]="true">
              Perguntar restrições alimentares
            </ion-toggle>
          </ion-item>

          <ion-item>
            <ion-toggle [(ngModel)]="askSongRequest" [enableOnOffLabels]="true">
              Perguntar pedido de música
            </ion-toggle>
          </ion-item>

          <ion-item>
            <ion-toggle [(ngModel)]="askChildrenInfo" [enableOnOffLabels]="true">
              Perguntar informação sobre filhos
            </ion-toggle>
          </ion-item>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Preview Section -->
    <div class="preview-section">
      <div class="preview-header">
        <h3>
          <ion-icon name="eye-outline"></ion-icon>
          Pré-visualização
        </h3>
        <p>Assim ficará o seu convite</p>
      </div>

      <div class="preview-card">
        <app-invitation-card
          [event]="previewEvent()"
          [showEnvelope]="false"
          [showCountdown]="true"
        ></app-invitation-card>
      </div>

      <div class="preview-info">
        <ion-card>
          <ion-card-content>
            <p>
              ✨ O convite atualiza automaticamente conforme preenche os campos
            </p>
          </ion-card-content>
        </ion-card>

        <!-- Animation Button -->
        <ion-button
          expand="block"
          fill="outline"
          color="secondary"
          (click)="openAnimationModal()"
          class="animation-button"
        >
          <ion-icon name="play-circle-outline" slot="start"></ion-icon>
          Ver Animação Completa
        </ion-button>
      </div>
    </div>
  </div>

  <!-- Sticky CTA -->
  <div class="cta-footer">
    <ion-card>
      <ion-card-content>
        <div class="cta-content">
          <div class="cta-info">
            <h4>Pronto para continuar?</h4>
            <p>Apenas <strong>€29</strong> para criar o seu evento</p>
          </div>
          <ion-button
            expand="block"
            size="large"
            [disabled]="!isValid()"
            (click)="proceedToPayment()"
          >
            <ion-icon name="arrow-forward-outline" slot="end"></ion-icon>
            Continuar para Pagamento
          </ion-button>
          
          @if (!isValid()) {
            <div class="validation-hint">
              <ion-icon name="checkmark-circle-outline"></ion-icon>
              Preencha: Nome do anfitrião, Data e Local
            </div>
          }
        </div>
      </ion-card-content>
    </ion-card>
  </div>
</ion-content>

<!-- Animation Modal -->
<ion-modal
  [isOpen]="showAnimationModal()"
  (didDismiss)="closeAnimationModal()"
  [backdropDismiss]="false"
  class="animation-modal"
>
  <ng-template>
    <div class="modal-header">
      <h2>Animação do Convite</h2>
      <ion-button
        fill="clear"
        (click)="closeAnimationModal()"
        class="close-button"
      >
        <ion-icon name="close-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </div>

    <div class="modal-content">
      <div class="animation-container">
        <app-envelope-opener
          [event]="previewEvent()"
          (opened)="onEnvelopeOpened()"
        >
          <app-invitation-card
            [event]="previewEvent()"
            [showEnvelope]="false"
            [showCountdown]="true"
          ></app-invitation-card>
        </app-envelope-opener>
      </div>
    </div>

    <div class="modal-footer">
      <ion-button
        expand="block"
        (click)="closeAnimationModal()"
      >
        Fechar
      </ion-button>
    </div>
  </ng-template>
</ion-modal>
