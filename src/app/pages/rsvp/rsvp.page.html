@if (event(); as currentEvent) {

<!-- ==================== RSVP CONTENT ==================== -->
<ion-content class="rsvp-content">
  <!-- Envelope Overlay + Convite real dentro da carta -->
  @if (!submitted()) {
  <div class="envelope-overlay">
    <app-envelope-opener
      [event]="currentEvent"
      (opened)="onEnvelopeOpened()"
    >
      <app-invitation-card
        [event]="currentEvent"
        [showEnvelope]="false"
        [showCountdown]="false"
        [showSchedule]="false"
        [compact]="true"
      >
      <!-- RSVP Form projected into card -->
      <div class="rsvp-form">
      <h2>Confirma a tua presen√ßa</h2>

      <!-- Personalized greeting for invitation-based RSVP -->
      @if (!isLegacyMode()) {
      <div class="guest-greeting">
        @if (invitationType() === 'couple') {
        <p class="greeting-name">
          {{ primaryGuestName() }} & {{ secondaryGuestName() }}
        </p>
        } @else {
        <p class="greeting-name">{{ primaryGuestName() }}</p>
        } @if (hasChildren()) {
        <p class="greeting-sub">e fam√≠lia</p>
        }
      </div>
      }

      <!-- Legacy mode: ask for name/email/phone -->
      @if (isLegacyMode()) {
      <div class="form-group">
        <label>O teu nome *</label>
        <ion-input
          [(ngModel)]="guestName"
          placeholder="Nome completo"
          fill="outline"
        >
        </ion-input>
      </div>

      <div class="form-group">
        <label>Email</label>
        <ion-input
          [(ngModel)]="guestEmail"
          type="email"
          placeholder="email@exemplo.com"
          fill="outline"
        >
        </ion-input>
      </div>

      <div class="form-group">
        <label>Telefone</label>
        <ion-input
          [(ngModel)]="guestPhone"
          type="tel"
          placeholder="+351 912 345 678"
          fill="outline"
        >
        </ion-input>
      </div>
      }

      <div class="form-group">
        <label>Vai poder estar presente?</label>
        <div class="radio-options">
          <div
            class="radio-option"
            [class.selected]="attending === 'yes'"
            (click)="attending = 'yes'"
          >
            <ion-icon
              name="checkmark-circle-outline"
              color="success"
            ></ion-icon>
            <span>Sim, estarei presente!</span>
          </div>
          <div
            class="radio-option"
            [class.selected]="attending === 'no'"
            (click)="attending = 'no'"
          >
            <ion-icon name="close-circle-outline" color="danger"></ion-icon>
            <span>Infelizmente n√£o poderei</span>
          </div>
          <div
            class="radio-option"
            [class.selected]="attending === 'maybe'"
            (click)="attending = 'maybe'"
          >
            <ion-icon name="help-circle-outline" color="medium"></ion-icon>
            <span>Ainda n√£o sei</span>
          </div>
        </div>
      </div>

      @if (attending === 'yes' && allowsPlusOne()) {
      <div class="form-group">
        <!-- Only show toggle in legacy mode or single-plus-one -->
        @if (isLegacyMode() || invitationType() === 'single-plus-one') {
        <ion-item lines="none" class="toggle-item">
          <ion-toggle [(ngModel)]="bringingPlusOne"
            >Vou levar acompanhante</ion-toggle
          >
        </ion-item>
        }
        @if (bringingPlusOne || invitationType() === 'single-plus-one') {
          @if (isLegacyMode()) {
          <ion-input
            [(ngModel)]="plusOneName"
            placeholder="Nome do acompanhante"
            fill="outline"
            class="plus-one-input"
          >
          </ion-input>
          }
          @if (currentEvent.askDietaryRestrictions) {
          <div class="plus-one-dietary">
            <label>Restri√ß√µes alimentares do acompanhante</label>
            <app-dietary-select [(ngModel)]="plusOneDietary"></app-dietary-select>
          </div>
          }
        }
      </div>
      }

      <!-- Couple: Secondary guest section -->
      @if (attending === 'yes' && invitationType() === 'couple') {
      <div class="form-group couple-section">
        <div class="section-header">
          <span class="section-title">{{ secondaryGuestName() }}</span>
        </div>
        <ion-item lines="none" class="toggle-item">
          <ion-toggle [(ngModel)]="secondaryAttending"
            >Vai estar presente</ion-toggle
          >
        </ion-item>
        @if (secondaryAttending && currentEvent.askDietaryRestrictions) {
        <div class="secondary-dietary">
          <label>Restri√ß√µes alimentares</label>
          <app-dietary-select [(ngModel)]="secondaryDietary"></app-dietary-select>
        </div>
        }
      </div>
      }

      <!-- Children section -->
      @if (attending === 'yes' && hasChildren()) {
      <div class="form-group children-section">
        <div class="section-header">
          <span class="section-title">Filhos</span>
        </div>
        <div class="children-count">
          <label>Quantos filhos v√£o estar presentes?</label>
          <ion-select
            [(ngModel)]="childrenAttending"
            interface="popover"
            fill="outline"
          >
            @for (i of getChildrenOptions(); track i) {
            <ion-select-option [value]="i">{{ i }}</ion-select-option>
            }
          </ion-select>
        </div>
        @if (childrenAttending > 0 && currentEvent.askDietaryRestrictions) {
        <div class="children-dietary">
          <label>Restri√ß√µes alimentares dos filhos</label>
          <app-dietary-select [(ngModel)]="childrenDietary"></app-dietary-select>
        </div>
        }
      </div>
      }

      @if (attending === 'yes' && currentEvent.askDietaryRestrictions) {
      <div class="form-group">
        <label>Restri√ß√µes alimentares ou alergias</label>
        <app-dietary-select [(ngModel)]="primaryDietary"></app-dietary-select>
      </div>
      }

      @if (attending === 'yes' && currentEvent.askSongRequest) {
      <div class="form-group">
        <label>Sugest√£o de m√∫sica üéµ</label>
        <ion-input
          [(ngModel)]="songRequest"
          placeholder="Qual m√∫sica n√£o pode faltar?"
          fill="outline"
        >
        </ion-input>
      </div>
      }

      <div class="form-group">
        <label>Mensagem para os anfitri√µes</label>
        <ion-textarea
          [(ngModel)]="message"
          placeholder="Deixe uma mensagem..."
          fill="outline"
          [autoGrow]="true"
          rows="3"
        >
        </ion-textarea>
      </div>

      <ion-button expand="block" (click)="submit()" class="submit-button">
        Confirmar Resposta
      </ion-button>

      @if (currentEvent.rsvpDeadline) {
      <p class="deadline">
        Responde at√© {{ formatDate(currentEvent.rsvpDeadline) }}
      </p>
      }
      </div>
    </app-invitation-card>
    </app-envelope-opener>
  </div>
  }

  @if (submitted()) {
  <!-- Thank You Message -->
  <div class="thank-you">
    <div
      class="icon-wrapper"
      [class.confirmed]="response() === 'confirmed'"
      [class.declined]="response() === 'declined'"
    >
      @if (response() === 'confirmed') {
      <ion-icon name="checkmark-circle-outline"></ion-icon>
      } @else if (response() === 'declined') {
      <ion-icon name="close-circle-outline"></ion-icon>
      } @else {
      <ion-icon name="help-circle-outline"></ion-icon>
      }
    </div>

    <h1>Obrigado, {{ guestName }}!</h1>

    @if (response() === 'confirmed') {
    <p>
      A tua presen√ßa est√° confirmada. Mal podemos esperar para celebrar contigo!
    </p>
    } @else if (response() === 'declined') {
    <p>Lamentamos que n√£o possas estar presente. Obrigado por responder.</p>
    } @else {
    <p>Obrigado por responder. Esperamos ter not√≠cias tuas em breve!</p>
    }

    <div class="event-reminder">
      <h3>{{ currentEvent.title }}</h3>
      <p>{{ formatDate(currentEvent.date) }}</p>
      <p>{{ currentEvent.venue.name }}, {{ currentEvent.venue.city }}</p>
    </div>
  </div>
  }
</ion-content>

} @else {
<ion-content class="ion-padding">
  <div class="not-found">
    <h1>Convite n√£o encontrado</h1>
    <p>O c√≥digo de convite n√£o √© v√°lido ou o evento j√° n√£o est√° dispon√≠vel.</p>
  </div>
</ion-content>
}
